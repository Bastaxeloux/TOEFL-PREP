<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOEFL Task 5 - Integrated Writing</title>
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon.png') }}?v=2">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div id="app" class="toefl-container">
        <!-- Setup Screen -->
        <div id="setupScreen" class="screen">
            <div class="header-logo-container">
                <img src="{{ url_for('static', filename='favicon.png') }}" alt="TOEFL Logo" class="page-logo">
            </div>
            <h1 class="toefl-header">Task 5: Integrated Writing</h1>

            <div class="task-instructions">
                <p><strong>Format:</strong> Read (3 min) → Listen (2-3 min) → Write (20 min)</p>
                <p>You will read an academic passage, listen to a lecture that challenges it, then write an essay (150-225 words) summarizing the lecture's points and how they counter the reading.</p>
            </div>

            <div class="config-section">
                <div class="config-item">
                    <label for="apiKey">OpenAI API Key (required for evaluation):</label>
                    <div class="api-key-input-group">
                        <input type="password" id="apiKey" placeholder="sk-..." value="{{ api_key }}">
                        <button id="saveApiKeyBtn" class="btn btn-success btn-compact">Save</button>
                    </div>
                </div>

                <div class="config-item">
                    <label for="promptSelect">Select Prompt:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <select id="promptSelect" style="flex: 1; padding: 8px; font-size: 14px; border: 2px solid #333; border-radius: 4px;">
                            <option value="">-- Random Prompt --</option>
                        </select>
                        <button id="newPromptBtn" class="btn btn-success" style="white-space: nowrap;">New Prompt</button>
                        <button id="editPromptBtn" class="btn" style="background-color: #007bff; color: white; white-space: nowrap;">Edit</button>
                    </div>
                </div>

                <div class="config-item">
                    <label>Reading Passage:</label>
                    <div id="readingDisplay" style="padding: 15px; background-color: #f5f5f5; border: 2px solid #ccc; border-radius: 4px; min-height: 150px; white-space: pre-wrap; font-family: inherit; line-height: 1.6; color: #333;">
                        <em style="color: #999;">Random mode - content will be selected when you start the task</em>
                    </div>
                </div>

                <div class="config-item">
                    <label>Associated Audio:</label>
                    <div id="audioDisplay" style="padding: 10px; background-color: #f5f5f5; border: 2px solid #ccc; border-radius: 4px; color: #666;">
                        <em>Random mode</em>
                    </div>
                </div>
            </div>

            <div class="button-container">
                <button id="startTaskButton" class="btn btn-primary btn-highlight">Start Task</button>
                <button onclick="window.location.href='/other-tasks'" class="btn btn-warning">Back to Task Menu</button>
            </div>
            <div id="saveMessage" class="save-message"></div>
        </div>

        <!-- Practice Screen -->
        <div id="practiceScreen" class="screen" style="display: none;">
            <h1 class="toefl-header">Task 5: Integrated Writing</h1>

            <!-- Reading Phase -->
            <div id="readingPhase" class="phase-section" style="display: none;">
                <h2>Reading Time: <span id="readingTimer">180</span>s</h2>
                <div class="reading-passage" id="readingPassage"></div>
            </div>

            <!-- Listening Phase -->
            <div id="listeningPhase" class="phase-section" style="display: none;">
                <h2>Listen to the lecture</h2>
                <audio id="lectureAudio" controls></audio>
                <p class="instruction-text">Click play when ready. The writing timer will start when the audio finishes.</p>
            </div>

            <!-- No Audio Phase -->
            <div id="noAudioPhase" class="phase-section" style="display: none;">
                <h2>No Audio Available</h2>
                <p class="instruction-text">You didn't upload an audio file. You can proceed to writing, but the AI evaluation will focus on vocabulary, grammar, and structure rather than content accuracy.</p>
                <button id="continueWithoutAudio" class="btn btn-primary">Continue to Writing</button>
            </div>

            <!-- Writing Phase -->
            <div id="writingPhase" class="phase-section" style="display: none;">
                <h2>Writing Time: <span id="writingTimer">1200</span>s (20 minutes)</h2>
                <div class="toefl-prompt" style="margin-bottom: 15px; padding: 15px; background-color: #f5f5f5; border: 2px solid #333; border-radius: 4px;">
                    <p><strong>Directions:</strong> You have 20 minutes to plan and write your response. Your response will be judged on the quality of your writing and on how well your response presents the points in the lecture and their relationship to the reading passage. Typically, an effective response will be 150 to 225 words.</p>
                    <p style="margin-top: 10px;"><strong>Question:</strong> Summarize the points made in the lecture, being sure to explain how they challenge the specific points made in the reading passage.</p>
                </div>
                <div style="display: flex; gap: 15px; margin-bottom: 10px; align-items: center;">
                    <button id="showReadingBtn" class="btn btn-secondary" style="font-size: 14px;">Show Reading</button>
                    <span style="color: #666; font-size: 14px;">Word count: <strong id="wordCount">0</strong></span>
                </div>
                <textarea id="writingArea" style="width: 100%; min-height: 400px; padding: 15px; border: 2px solid #333; font-family: 'Georgia', 'Times New Roman', serif; font-size: 16px; line-height: 1.6; resize: vertical; box-sizing: border-box;" placeholder="Type your response here..."></textarea>
                <div class="button-container" style="margin-top: 15px;">
                    <button id="submitWritingBtn" class="btn btn-primary">Submit Response</button>
                </div>
            </div>

            <!-- Results Phase -->
            <div id="resultsPhase" class="phase-section" style="display: none;">
                <h2>Your Response</h2>
                <div class="config-item" style="margin-bottom: 20px;">
                    <label>Your Essay:</label>
                    <div id="submittedText" style="padding: 15px; background-color: #f5f5f5; border: 2px solid #ccc; border-radius: 4px; white-space: pre-wrap; font-family: 'Georgia', 'Times New Roman', serif; line-height: 1.6;"></div>
                </div>
                <div id="evaluationResults" class="progress-container"></div>
                <div class="button-container">
                    <button id="resetButton" class="btn btn-warning">Try Again</button>
                    <button onclick="window.location.href='/other-tasks'" class="btn btn-primary">Back to Task Menu</button>
                </div>
            </div>
        </div>

        <!-- Modal for creating/editing prompts -->
        <div id="promptModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">New Prompt</h2>
                    <span class="modal-close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="config-item">
                        <label for="modalReadingText">Reading Passage (230-300 words):</label>
                        <textarea id="modalReadingText" rows="10" placeholder="Paste the academic reading passage here..."></textarea>
                    </div>
                    <div class="config-item">
                        <label for="modalAudioSelect">Lecture Audio (2-3 minutes):</label>
                        <div style="margin-bottom: 10px;">
                            <select id="modalAudioSelect" style="width: 100%; padding: 8px; font-size: 14px; border: 2px solid #333; border-radius: 4px;">
                                <option value="">-- Select existing audio or upload new --</option>
                            </select>
                        </div>
                        <label for="modalAudioUpload" style="font-weight: normal; color: #666;">Or upload new audio file:</label>
                        <input type="file" id="modalAudioUpload" accept="audio/*">
                        <div id="modalAudioStatus" class="audio-status"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="modalDeleteBtn" class="btn" style="background-color: #dc3545; color: white; margin-right: auto;">Delete</button>
                    <button id="modalCancelBtn" class="btn">Cancel</button>
                    <button id="modalSaveBtn" class="btn btn-success">Save Prompt</button>
                </div>
            </div>
        </div>

        <!-- Modal for showing reading during writing -->
        <div id="readingModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Reading Passage</h2>
                    <span class="modal-close" data-modal="readingModal">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="modalReadingContent" style="white-space: pre-wrap; font-family: inherit; line-height: 1.6;"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="document.getElementById('readingModal').style.display='none'">Close</button>
                </div>
            </div>
        </div>

        <div class="github-link">
            <p>Open source project - <a href="https://github.com/Bastaxeloux/TOEFL-PREP" target="_blank">View on GitHub</a></p>
        </div>
    </div>

    <script src="{{ url_for('static', filename='task5.js') }}"></script>
</body>
</html>
